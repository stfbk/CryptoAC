{"version":3,"file":"ktor-ktor-serialization-js-legacy.js","sources":["../../../../../common/src/flow/operators/Emitters.kt","../../../../../common/src/flow/internal/SafeCollector.common.kt","../../../../../ktor-utils/js/src/io/ktor/util/reflect/TypeInfoJs.kt","../../../../../ktor-utils/common/src/io/ktor/util/reflect/Type.kt","../../../../../ktor-shared/ktor-serialization/common/src/ContentConvertException.kt","../../../../../common/src/flow/operators/Transform.kt","../../../../../ktor-shared/ktor-serialization/common/src/ContentConverter.kt","../../../../../ktor-shared/ktor-serialization/common/src/WebsocketContentConverter.kt"],"sourcesContent":[null,null,"/*\n * Copyright 2014-2021 JetBrains s.r.o and contributors. Use of this source code is governed by the Apache 2.0 license.\n */\n\npackage io.ktor.util.reflect\n\nimport kotlin.reflect.*\n\npublic actual interface Type\n\npublic object JsType : Type\n\n@OptIn(ExperimentalStdlibApi::class)\npublic actual inline fun <reified T> typeInfo(): TypeInfo = typeInfoImpl(JsType, T::class, tryGetType<T>())\n\npublic fun typeInfoImpl(reifiedType: Type, kClass: KClass<*>, kType: KType?): TypeInfo =\n    TypeInfo(kClass, reifiedType, kType)\n\n/**\n * Check [this] is instance of [type].\n */\npublic actual fun Any.instanceOf(type: KClass<*>): Boolean = type.isInstance(this)\n\npublic actual val KType.platformType: Type\n    get() = JsType\n","/*\n * Copyright 2014-2021 JetBrains s.r.o and contributors. Use of this source code is governed by the Apache 2.0 license.\n */\n\npackage io.ktor.util.reflect\n\nimport kotlin.reflect.*\n\n/**\n * Information about type.\n */\npublic expect interface Type\n\npublic expect val KType.platformType: Type\n\n/**\n * Ktor type information.\n * @property type: source KClass<*>\n * @property reifiedType: type with substituted generics\n * @property kotlinType: kotlin reified type with all generic type parameters.\n */\npublic data class TypeInfo(\n    public val type: KClass<*>,\n    public val reifiedType: Type,\n    public val kotlinType: KType? = null\n)\n\n/**\n * Returns [TypeInfo] for the specified type [T]\n */\npublic expect inline fun <reified T> typeInfo(): TypeInfo\n\n/**\n * Check [this] is instance of [type].\n */\npublic expect fun Any.instanceOf(type: KClass<*>): Boolean\n\n@PublishedApi\n@OptIn(ExperimentalStdlibApi::class)\ninternal inline fun <reified T> tryGetType(): KType? = try {\n    // We need to wrap getting type in try catch because of https://youtrack.jetbrains.com/issue/KT-42913\n    typeOf<T>()\n} catch (cause: Throwable) {\n    null\n}\n","/*\n * Copyright 2014-2021 JetBrains s.r.o and contributors. Use of this source code is governed by the Apache 2.0 license.\n */\n\npackage io.ktor.serialization\n\nimport io.ktor.websocket.*\n\npublic open class ContentConvertException(\n    message: String,\n    cause: Throwable? = null\n) : Exception(message, cause)\n\npublic class JsonConvertException(\n    message: String,\n    cause: Throwable? = null\n) : ContentConvertException(message, cause)\n\npublic open class WebsocketContentConvertException(\n    message: String,\n    cause: Throwable? = null\n) : ContentConvertException(message, cause)\n\npublic class WebsocketConverterNotFoundException(\n    message: String,\n    cause: Throwable? = null\n) : WebsocketContentConvertException(message, cause)\n\npublic class WebsocketDeserializeException(\n    message: String,\n    cause: Throwable? = null,\n    public val frame: Frame\n) : WebsocketContentConvertException(message, cause)\n",null,"/*\n * Copyright 2014-2021 JetBrains s.r.o and contributors. Use of this source code is governed by the Apache 2.0 license.\n */\n\npackage io.ktor.serialization\n\nimport io.ktor.http.*\nimport io.ktor.http.content.*\nimport io.ktor.util.*\nimport io.ktor.util.pipeline.*\nimport io.ktor.util.reflect.*\nimport io.ktor.utils.io.*\nimport io.ktor.utils.io.charsets.*\nimport io.ktor.utils.io.core.*\nimport kotlinx.coroutines.flow.*\nimport kotlin.reflect.*\n\n/**\n * A custom content converter that could be registered in [ContentNegotiation] plugin for any particular content type\n * Could provide bi-directional conversion implementation.\n * One of the most typical examples of content converter is a JSON content converter that provides both\n * serialization and deserialization\n *\n * Implementations must override at least one of [serialize] or [serializeNullable] methods.\n */\npublic interface ContentConverter {\n\n    /**\n     * Serializes a [value] to the specified [contentType] to a [OutgoingContent].\n     * This function could ignore value if it is not suitable for conversion and return `null` so in this case\n     * other registered converters could be tried or this function could be invoked with other content types\n     * it the converted has been registered multiple times with different content types.\n     *\n     * @param charset response charset\n     * @param typeInfo response body typeInfo\n     * @param contentType to which this data converter has been registered and that matches the client's [Accept] header\n     * @param value to be converted\n     *\n     * @return a converted [OutgoingContent] value, or null if [value] isn't suitable for this converter\n     */\n    @Deprecated(\n        \"Please override and use serializeNullable instead\",\n        level = DeprecationLevel.WARNING,\n        replaceWith = ReplaceWith(\"serializeNullable(charset, typeInfo, contentType, value)\")\n    )\n    public suspend fun serialize(\n        contentType: ContentType,\n        charset: Charset,\n        typeInfo: TypeInfo,\n        value: Any\n    ): OutgoingContent? = serializeNullable(contentType, charset, typeInfo, value)\n\n    /**\n     * Serializes a [value] to the specified [contentType] to a [OutgoingContent].\n     * This function could ignore value if it is not suitable for conversion and return `null` so in this case\n     * other registered converters could be tried or this function could be invoked with other content types\n     * it the converted has been registered multiple times with different content types.\n     *\n     * @param charset response charset\n     * @param typeInfo response body typeInfo\n     * @param contentType to which this data converter has been registered and that matches the client's [Accept] header\n     * @param value to be converted\n     *\n     * @return a converted [OutgoingContent] value, or null if [value] isn't suitable for this converter\n     */\n    @Suppress(\"DEPRECATION\")\n    public suspend fun serializeNullable(\n        contentType: ContentType,\n        charset: Charset,\n        typeInfo: TypeInfo,\n        value: Any?\n    ): OutgoingContent? = serialize(contentType, charset, typeInfo, value!!)\n\n    /**\n     * Deserializes [content] to the value of type [typeInfo]\n     *\n     * @return a converted value (deserialized) or `null` if the context's subject is not suitable for this converter\n     */\n    public suspend fun deserialize(charset: Charset, typeInfo: TypeInfo, content: ByteReadChannel): Any?\n}\n\n/**\n * Detect suitable charset for an application call by `Accept` header or fallback to [defaultCharset]\n */\npublic fun Headers.suitableCharset(defaultCharset: Charset = Charsets.UTF_8): Charset =\n    suitableCharsetOrNull(defaultCharset) ?: defaultCharset\n\n/**\n * Detect suitable charset for an application call by `Accept` header or fallback to null\n */\npublic fun Headers.suitableCharsetOrNull(defaultCharset: Charset = Charsets.UTF_8): Charset? {\n    for ((charset, _) in parseAndSortHeader(get(HttpHeaders.AcceptCharset))) when {\n        charset == \"*\" -> return defaultCharset\n        Charset.isSupported(charset) -> return Charset.forName(charset)\n    }\n    return null\n}\n\n/**\n * Configuration for client and server `ContentNegotiation` plugin\n */\npublic interface Configuration {\n\n    public fun <T : ContentConverter> register(\n        contentType: ContentType,\n        converter: T,\n        configuration: T.() -> Unit = {}\n    )\n}\n\n@InternalAPI\npublic suspend fun List<ContentConverter>.deserialize(\n    body: ByteReadChannel,\n    typeInfo: TypeInfo,\n    charset: Charset\n): Any {\n    // Pick the first one that can convert the subject successfully.\n    // The result can be null if\n    // 1. there is no suitable converter\n    // 2. result of deserialization is null\n    // We can differentiate these cases by checking if body was consumed or not\n    val result = asFlow().map { converter ->\n        converter.deserialize(\n            charset = charset,\n            typeInfo = typeInfo,\n            content = body\n        )\n    }.firstOrNull { it != null || body.isClosedForRead }\n\n    return when {\n        result != null -> result\n        !body.isClosedForRead -> body\n        typeInfo.kotlinType?.isMarkedNullable == true -> NullBody\n        else -> throw ContentConvertException(\"No suitable converter found for $typeInfo\")\n    }\n}\n","/*\n * Copyright 2014-2021 JetBrains s.r.o and contributors. Use of this source code is governed by the Apache 2.0 license.\n */\n\npackage io.ktor.serialization\n\nimport io.ktor.http.*\nimport io.ktor.http.content.*\nimport io.ktor.util.reflect.*\nimport io.ktor.utils.io.*\nimport io.ktor.utils.io.charsets.*\nimport io.ktor.websocket.*\n\n/**\n * A custom content converter that could be used in the [WebSockets] plugin\n * Could provide bi-directional conversion implementation.\n * One of the most typical examples of the content converter is a JSON converter that provides\n * both serialization and deserialization\n *\n * Implementations must override at least one of [serialize] or [serializeNullable] methods.\n */\npublic interface WebsocketContentConverter {\n    /**\n     * Serializes a [value] to a WebSocket [Frame].\n     * This function could throw `WebsocketConverterNotFoundException` if the value is not suitable for conversion\n     *\n     * @param charset response charset\n     * @param typeInfo response body typeInfo\n     * @param value to be converted\n     *\n     * @return a converted [Frame] value, or null if [value] isn't suitable for this converter\n     */\n    public suspend fun serialize(\n        charset: Charset,\n        typeInfo: TypeInfo,\n        value: Any\n    ): Frame = serializeNullable(charset, typeInfo, value)\n\n    /**\n     * Serializes a [value] to a WebSocket [Frame].\n     * This function could throw `WebsocketConverterNotFoundException` if the value is not suitable for conversion\n     *\n     * @param charset response charset\n     * @param typeInfo response body typeInfo\n     * @param value to be converted\n     *\n     * @return a converted [Frame] value, or null if [value] isn't suitable for this converter\n     */\n    public suspend fun serializeNullable(\n        charset: Charset,\n        typeInfo: TypeInfo,\n        value: Any?\n    ): Frame = serialize(charset, typeInfo, value!!)\n\n    /**\n     * Deserializes [content] to the value of type [typeInfo]\n     *\n     * @return a converted value (deserialized) or throws `WebsocketConverterNotFoundException` if the context's\n     * subject is not suitable for this converter\n     */\n    public suspend fun deserialize(charset: Charset, typeInfo: TypeInfo, content: Frame): Any?\n\n    /**\n     * Checks if the content converter can deserialize a [frame]\n     *\n     * @param frame a WebSocket frame\n     *\n     * @return true if the content converter can deserialize a [frame] type or false if a type of [frame]\n     * is not supported by the converter\n     */\n    public fun isApplicable(frame: Frame): Boolean\n}\n\n/**\n * Serializes a [value] to a WebSocket [Frame].\n * This function could throw `WebsocketConverterNotFoundException` if the value is not suitable for conversion\n *\n * @param charset response charset\n * @param value to be converted\n *\n * @return a converted [OutgoingContent] value, or null if [value] isn't suitable for this converter\n */\npublic suspend inline fun <reified T> WebsocketContentConverter.serialize(\n    value: T,\n    charset: Charset = Charsets.UTF_8\n): Frame = serializeNullable(charset, typeInfo<T>(), value)\n\n/**\n * Deserializes [content] to the value of type [T]\n *\n * @return a converted value (deserialized) or throws `WebsocketConverterNotFoundException` if the context's\n * subject is not suitable for this converter\n */\npublic suspend inline fun <reified T> WebsocketContentConverter.deserialize(\n    content: Frame,\n    charset: Charset = Charsets.UTF_8\n): T = deserialize(charset, typeInfo<T>(), content) as T\n"],"names":[],"mappings":"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C;qBAAA,mB;YAAA,Q;;;;YANF,aAME,a;YAGE,mB;cAAkB,a;iBAClB,KAAC,eAAK,gBAAN,C;cAAyB,sB;;cAChB,U;cAAT,MAAS,SAAT,mBAAS,WAAT,gDAAyC,IAAzC,C;gBAAiD,uB;;gBACzC,MAAM,4BAAwB,qCAAkC,mBAA1D,C;;;YAJlB,W;;;;;;;;;;;;;;;G;EAnBJ,4F;mBAAA,qF;QAAA,S;aAAA,Q;;aAAA,uB;G;oGCrCA,yB;IAAA,yF;IAAA,sE;IL7DA,sF;IAAA,gC;IAAA,gH;ICyBA,qB;IIoCA,oE;MAWI,uB;QAAA,UAAmB,iBAAS,M;MLvEyC,2B;;MAAkB,uB;;;UC0BpC,uD;;UAGrD,sC;YAHqD,sBAInD,I;YAJmD,sB;;YAAA,a;;;;MI8C5C,uDAAkB,OAAlB,ELxEiD,mDKwEjD,EAA0C,KAA1C,8B;MAAA,yD;K;GAZX,C;sGAcA,yB;IAAA,yF;IAAA,sE;IAAA,8B;IL3EA,sF;IAAA,gC;IAAA,gH;ICyBA,qB;IIkDA,sE;MAQI,uB;QAAA,UAAmB,iBAAS,M;MACzB,U;MLnFkE,2B;;MAAkB,uB;;;UC0BpC,uD;;UAGrD,sC;YAHqD,sBAInD,I;YAJmD,sB;;YAAA,a;;;;MIyDhD,iDAAY,OAAZ,ELnFqD,mDKmFrD,EAAoC,OAApC,8B;MAAA,6F;K;GATP,C;;;;;;;;;;;;;;;;;;;"}